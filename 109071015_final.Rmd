---
title: "金融大數據報告: 外匯三角套利與利差套利分析"
author: "作者: 109071015 QF24 張晁維"
date: "日期: 2023-06-17"
output: 
  html_document: 
    toc: yes
    fig_caption: yes
    code_folding: hide
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(skimr)
library(kableExtra) 
library(tidyverse)
library(stringr)
library(lattice)
library(shiny)
library(ggradar)
```

# 壹、研究主題

#### 本主題旨在分析國際外匯市場中的主流貨幣間是否存在三角套利與利差套利空間，首先是將套利的判斷建模；其次是以不同貨幣的套利組合、套利組合與常見機率分配函數加以比較；最後以Shiny套件建構可互動之操作介面，讓使用者可迅速、精確地獲取指定資訊。

# 貳、研究動機

#### 外匯交易的存在仰賴於持續變化、波動的外匯市場，這在固定匯率時期或是高度管理匯率時期所不敢想像的，而其中所藏的套利空間更是為投資人所垂涎，我認為這正是它吸引人處，例如為世人所津津樂道的渡邊太太。學生在大二下學期時曾修習曾祺峰教授所開的國際財務管理一課，其中學到許多關於外匯的知識，因此藉這次的機會將許多繁雜的計算、判斷程式化，且使其適用於大數據，而非僅止於單筆計算，並且加入與常見的機率分布的比較，增強使用者在比較套利空間上的需求。

# 參、研究目標

#### (i) 建立適用於大數據計算、輸入數據僅需簡單預處理的函數
#### (ii) 建立從不同視角下的視覺化比較
#### (iii) 建立與常見機率分布的視覺化比較
#### (iv) 建立互動式工具

# 肆、資料選擇與資料描述

#### 本報告選擇的時間區間為2022全年(2022/01/01~2022/12/31)，其中三角套利的部分採用的是日資料，共計260筆；利差套利採用的是週資料，共計53筆。資料來源為investing.com。前者的資料採集條件為"兩個具有美金報價且具有其中任一貨幣報價資料"之貨幣，如日圓及英鎊均有美金報價之資料，且具有以日圓報價之英鎊資料，則可納入資料集中；後者的資料採集條件為"具有目標國一月期期貨、其貨幣一月期債券殖利率、美金報價之該國貨幣的資料"。

# 伍、研究分析與結果

## 1. 外匯三角套利

### (i)原理

#### 利用兩貨幣對美元報價取餘數，再比較兩貨幣之直接報價。兩者差值越大即套利空間越大、越能彌補商業銀行的手續費、電報費或是其所在國所訂之外匯交易稅金。以下計算均採用該交易日之收盤價。

### (ii)資料引入與整理: 2022/1/1 \~ 2022/12/31；頻率: 日；共計260筆資料。

```{r aa1, echo=FALSE}
data1 <- read.csv("FX_data.csv")
print(head(data1))
```

### (iii)範例: 三角套利計算

```{r aa2, echo=TRUE}
dat1 <- data.frame(data1["GBP_USD"]/data1["JPY_USD"])
colnames(dat1) <- c("Price")
dat2 <- round(abs(dat1["Price"] - data1["GBP_JPY"])
              , digits=4)
dat2 <- cbind(data1["Date"], dat2)
colnames(dat2) <- c("Date", "GBP_JPY")
head(dat2)
```

### (iv)函式: 計算套利空間

#### TA, Triangular Arbitrage

```{r aa3}
TA <- function(data1){
  index <- colnames(data1)[2:10]
  df <- data.frame(data1["Date"])
  for(i in 1:5){
    n0 <- str_sub(index[i], start=1, end=3)
    n1 <- str_sub(index[i], start=5, end=7)
    for(j in 6:9){
      if(str_sub(index[j], start=1, end=3)==n0){
        t0 <- as.numeric(data1[, j+1])
      }else if(str_sub(index[j], start=1, end=3)==n1){
        t1 <- as.numeric(data1[, j+1])
      }
    }
    dat <- data.frame(round(abs(t0/t1-data1[, i+1])
                            , digits=4))
    df <- cbind(df, dat)
  }
  colnames(df) <- c("Date", index[1:5])
  return(df)
}
```

```{r aa4, echo=FALSE}
data2 <- TA(data1)
head(TA(data1))
```

### (v)互動式: 查詢特定日期之匯率收盤價

```{r aa5, echo=FALSE}
#shinyApp(
  #ui = fluidPage(
    #selectInput("date1"
                #, "Date:"
                #, choices = data1["Date"]),
    #tableOutput("test")
  #),
  #server = function(input, output) {
    #output$test = renderTable({
      #subset(data1, Date==input$date1)
    #})
  #},
  #options = list(height = 500)
#)
inputPanel(
  selectInput("date1", "Date: ", choices=data1["Date"])
)
renderTable({
  subset(data1, Date==input$date1)
})
```

### (vi)互動式: 查詢特定日期、特定貨幣以收盤價計價之套利空間

```{r aa6, echo=FALSE}
index <- colnames(data1)[2:6]
inputPanel(
  selectInput("date2", "Date: ", choices=data2["Date"]),
  selectInput("country1", "Currencies", choices=index)
)
renderTable({
  subset(data2, Date==input$date2, select=input$country1)
})
renderTable({
  subset(data2, Date==input$date2)
})
```

### (vii)互動式: 特定貨幣以收盤價計價之套利空間分布視覺化

```{r aa7, echo=FALSE}
index <- colnames(data1)[2:6]
inputPanel(
  selectInput("country2", "Currency 1", choices=index)
)
renderPlot({
  plot(subset(data2, select=input$country2)
       , col=2
       , main="Arbutrage Opportunity Distribution")
})
renderPlot({
  boxplot(subset(data2, select=input$country2)
          , horizontal=T
          , main=input$country2)
})
```

### (viii)互動式: 視覺化比較不同貨幣組合之套利空間

```{r aa8, echo=FALSE}
inputPanel(
  selectInput("country3", "Currency 1", choices=index),
  selectInput("country4", "Currency 2", choices=rev(index))
)
renderPlot({
  plot(subset(data2, select=input$country3)
       , col=2
       , xaxt='n')
  par(new=T)
  plot(subset(data2, select=input$country4)
       , col=3
       , main="Comparison: \nGreen: currency 1   Red: currency 2\n(Comparable as the denominators are the same)")
})
renderPlot({
  datat <- data.frame(subset(data2, select=input$country3)
                     , subset(data2, select=input$country4
                              ))
  boxplot(datat, horizontal=T)
})
```

### (ix)互動式: 視覺化比較套利空間分布與Chi-square PDF

#### PDF, Probability Density Function

```{r aa9}
#country: 8
index <- colnames(data1)[2:6]
inputPanel(
  selectInput("country9", "Currency 1", choices=index)
)
renderPlot({
  boxplot(dchisq(seq(from=0, to=0.1, by=0.01)
                 , df=1)*0.05
          , horizontal = T)
  par(new=T)
  plot(subset(data2, select=input$country9)
       , col=2
       , main="Arbutrage Opportunity Distribution\nwith chisq(1)*0.05"
       , xaxt='n'
       , xlim=c(0, 0.1))
})
```

## 2. 外匯利差套利

### (i)原理

#### 在連續複利計算的假設下，任兩國之利率差取自然數應等於目標國貨幣期貨、遠匯除以匯率現價。若存在差值，則同時買或賣貨幣並定存、賣或買期貨(遠匯)。兩者差值越大即套利空間越大、越能彌補商業銀行的手續費、電報費或是其所在國所訂之外匯交易稅金。以下計算均採用該交易日之收盤價。

#### *隱含假設:

#### a. 以美元作為母國貨幣。

#### b. 連續複利假設。

#### c. 所選債券與定存於該國均為無風險

### (ii)資料引入與整理: 2022/1/1 \~ 2022/12/31；頻率: 週；共計53筆資料。

```{r aa10, echo=FALSE}
data3 <- read.csv("Futures_Bond.csv")
print(head(data3))
```

### (iii)範例: 美元對加幣

```{r aa11, echo=TRUE}
dat31 <- data3["CADF"]/data3["CAD_USD"]*exp(data3["CADB"]/12)
dat4 <- round(abs(dat31-exp(data3["USDB"]/12)), digits=4)
dat4 <- cbind(data3["Date"], dat4)
colnames(dat4) <- c("Date", "USDtoCAD")
print(head(dat4))
```

### (iv)函式: 計算套利空間

#### CT, Carry Trade

```{r aa12, echo=TRUE}
CT <- function(data3){
  index <- colnames(data3)[2:11]
  df <- data.frame(data3["Date"])
  for(i in 1:3){
    n0 <- str_sub(index[i], start=1, end=3)
    d0 <- data3[, i+1]#目標國利率
    for(j in 4:6){
      if(str_sub(index[j], start=1, end=3)==n0){
        d1 <- data3[, j+1]#目標貨幣匯率
      }else if(str_sub(index[j], start=1, end=3)=="EUR" &
               n0=="FRF"){
        d1 <- data3[, j+1]#目標貨幣匯率(歐元區)
      }
    }
    for(k in 7:9){
      if(str_sub(index[k], start=1, end=3)==n0){
        d2 <- data3[, k+1]#目標貨幣遠匯
      }else if(str_sub(index[k], start=1, end=3)=="EUR" &
               n0=="FRF"){
        d2 <- data3[, k+1]#目標貨幣遠匯(歐元區)
      }
    }
    d3 <- data3[, 11]#本國利率
    dat0 <- d2/d1*exp(d0/12)
    dat1 <- round(abs(dat0-exp(d3/12)), digits=4)
    df <- cbind(df, dat1)
  }
  colnames(df) <- c("Date"
                      , "USDtoCAD"
                      , "USDtoEUR(FRF)"
                      , "USDtoGBP")
  return(df)
}
```

```{r aa13, echo=FALSE}
data4 <- CT(data3)
print(head(data4))
```

### (v)互動式: 查詢特定日期之一月期期貨、公債殖利率收盤價與匯率現價

#### F: futures; B: bonds

```{r aa14, echo=FALSE}
#date2, country4
inputPanel(
  selectInput("date3", "Date: ", choices=data3["Date"])
)
renderTable({
  subset(data3, Date==input$date3)
})
```

### (vi)互動式: 查詢特定日期、特定目標國家之套利空間

#### 注意: 對屬於歐元區之國家，以下債券數據採用該國債券、期貨數據則為歐元期貨

```{r aa15, echo=FALSE}
index <- colnames(data4)[2:4]
inputPanel(
  selectInput("date4", "Date: ", choices=data4["Date"]),
  selectInput("country5", "Countries: ", choices=index)
)
renderTable({
  subset(data4, Date==input$date4, select=input$country5)
})
renderTable({
  subset(data4, Date==input$date4)
})
```

### (vii)互動式: 套利空間分布視覺化

```{r aa16, echo=FALSE}
index <- colnames(data4)[2:4]
inputPanel(
  selectInput("country6", "Countries: ", choices=index)
)
renderPlot({
  plot(subset(data4, select=input$country6)
       , col=2
       , main="Arbutrage Opportunity Distribution")
})
renderPlot({
  boxplot(subset(data4, select=input$country6)
          , horizontal=T
          , main=input$country6)
})
```

### (viii)互動式: 視覺化比較不同標的之套利空間

```{r aa17, echo=FALSE}
index <- colnames(data4)[2:4]
inputPanel(
  selectInput("country7", "Currency 1", choices=index),
  selectInput("country8", "Currency 2", choices=rev(index))
)
renderPlot({
  plot(subset(data4, select=input$country7)
       , col=2
       , xaxt='n')
  par(new=T)
  plot(subset(data4, select=input$country8)
       , col=3
       , main="Comparison: \nGreen: currency 1   Red: currency 2\n(Comparable as the denominators are the same)")
})
renderPlot({
  datat2 <- data.frame(subset(data4, select=input$country7)
                     , subset(data4, select=input$country8
                              ))
  boxplot(datat2, horizontal=T)
})
```

### (ix)互動式: 視覺化比較套利空間分布與Chi-square PDF

#### PDF, Probability Density Function

```{r aa18, echo=FALSE}
#country: 9
index <- colnames(data4)[2:4]
inputPanel(
  selectInput("country10", "Country: ", choices=index)
)
renderPlot({
  boxplot(dchisq(seq(from=0, to=0.1, by=0.01)
                 , df=1)*0.05
          , horizontal = T)
  par(new=T)
  plot(subset(data4, select=input$country10)
       , col=2
       , main="Arbutrage Opportunity Distribution\nwith chisq(1)*0.05"
       , xaxt='n'
       , xlim=c(0, 0.2))
})
```

# 陸、結論

#### 從上述結果可見，

# 柒、指定問題